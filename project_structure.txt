# Структура проекта и описание функций

Этот документ содержит обзор файловой структуры проекта и описание основных функций для каждого модуля.

## Структура проекта

```
/
|-- main.py                 # Главный файл для запуска бота
|-- config.py               # Конфигурация: токены, ID администраторов, данные сотрудников
|-- requirements.txt        # Список зависимостей Python
|-- project_structure.txt   # Этот файл
|
|-- db_bot/
|   |-- __init__.py           # Превращает db_bot в пакет
|   |
|   |-- database/
|   |   |-- __init__.py     # Превращает database в подпакет
|   |   |-- db_manager.py     # Модуль для взаимодействия с базой данных Firebird
|   |
|   |-- handlers/
|   |   |-- __init__.py     # Превращает handlers в подпакет
|   |   |-- event_handlers.py # Обработчики для создания и редактирования событий
|   |   |-- other_handlers.py # Обработчики для команд /start, /help и др.
|   |
|   |-- keyboards/
|   |   |-- __init__.py     # Превращает keyboards в подпакет
|   |   |-- keyboards.py      # Модуль для создания всех клавиатур бота
|   |
|   |-- states/
|       |-- __init__.py     # Превращает states в подпакет
|       |-- states.py         # Определения состояний FSM (машины состояний)
```

## Описание функций

### `main.py`

- **`start_handler`**: Обрабатывает команду `/start`. Отправляет приветственное сообщение и основную клавиатуру.
- **`help_handler`**: Обрабатывает команду `/help`. Отправляет информационное сообщение с описанием функций бота.
- **`register_handlers`**: Регистрирует все обработчики сообщений, колбэков и команд в диспетчере.
- **`main`**: Основная асинхронная функция, которая инициализирует и запускает бота.

### `db_bot/database/db_manager.py`

- **`get_connection`**: Устанавливает и возвращает соединение с базой данных Firebird.
- **`_process_queue`**: Обрабатывает внутреннюю очередь событий, которые не были добавлены в БД из-за временной недоступности.
- **`_insert_event`**: Вставляет одну запись о событии (вход/выход) в таблицы `TABEL_INTERMEDIADATE` и `REG_EVENTS`.
- **`create_event`**: Основной метод для создания события. Использует очередь для отказоустойчивости.
- **`get_intermediate_data`**: Получает данные о событиях сотрудника из `TABEL_INTERMEDIADATE` за последние 2 дня.
- **`get_employees_work_status`**: Определяет, находится ли сотрудник на работе, на основе последнего события.
- **`get_reg_events_data`**: Получает "сырые" данные о событиях сотрудника из `REG_EVENTS` за последние 2 дня.
- **`get_last_four_events`**: Получает последние 4 события из `TABEL_INTERMEDIADATE` для функции редактирования.
- **`update_event_time`**: Обновляет время у существующего события в обеих таблицах (`TABEL_INTERMEDIADATE` и `REG_EVENTS`).

### `db_bot/handlers/event_handlers.py`

- **`edit_time_handler`**: Запускает процесс редактирования, показывая последние 4 события в виде кнопок.
- **`select_event_for_edit_handler`**: Срабатывает при выборе события для редактирования, запрашивает новое время.
- **`process_new_time_handler`**: Получает новое время от пользователя и обновляет запись в БД.
- **`create_handler`**: Запускает процесс создания нового события, предлагая выбрать сотрудника.
- **`create_event_staff_handler`**: Обрабатывает выбор сотрудника.
- **`event_type_handler`**: Обрабатывает выбор типа события (вход/выход).
- **`process_date`**: Обрабатывает ввод даты (через кнопки или вручную).
- **`process_time`**: Обрабатывает ввод времени и завершает процесс создания события, вызывая `db_manager.create_event`.

### `db_bot/keyboards/keyboards.py`

- **`create_main_keyboard`**: Создает главную клавиатуру (`Получить данные`, `Создать событие`).
- **`create_staff_keyboard`**: Создает инлайн-клавиатуру со списком сотрудников.
- **`create_event_type_keyboard`**: Создает инлайн-клавиатуру для выбора типа события (`Вход`/`Выход`).
- **`create_quick_date_keyboard`**: Создает клавиатуру для быстрого выбора даты (`Сегодня`/`Вчера`).
- **`create_quick_time_keyboard`**: Создает клавиатуру для быстрого выбора времени.
- **`create_events_for_edit_keyboard`**: Создает инлайн-клавиатуру со списком последних событий для редактирования.

### `db_bot/states/states.py`

- **`EventStates`**: Класс, определяющий состояния для машины состояний (FSM), используемые в процессе создания и редактирования событий (`waiting_for_date`, `waiting_for_time`, `waiting_for_new_time`).

